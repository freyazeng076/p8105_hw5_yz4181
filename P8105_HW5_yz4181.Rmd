---
title: "P8105_HW5_yz4181"
author: "Yuanyuan Zeng(yz4181)"
date: "11/16/2021"
output: github_document
---
```{r stepup, echo=FALSE}
library(tidyverse)

knitr::opts_chunk$set(
  echo = TRUE, message = FALSE, warning = FALSE,
  fig.width = 8,
  fig.height = 6,
  out.width = "80%",
  dpi = 300
)
```

## Problem 1

```{r}
## load the data set
homicide_df= read_csv("./homicide-data.csv", na = c("", "unknown")) %>% print()
```
* Description of raw dataset: The original data contains 52179 rows and 12 columns. The variables includes the case number, reported date, names and identities of victims, city and states of the cases, locations, and disposition. There are missing value in latitude and longitude columns. The value in age column is not consistent.


#### Unsolved and total homocides within each city
```{r}
## Clean data set
homicide_df = homicide_df %>% 
  mutate(city_state = str_c(city, state),
         resolution = case_when(
           disposition == "Closed without arrest" ~ "unsolved",
           disposition == "Open/No arrest" ~ "unsolved",
           disposition == "Closed by arrest" ~ "solved")) %>% 
  relocate(city_state) %>% 
  filter(city_state != "TulsaAL")

# summarize within city
total_homocide = homicide_df %>% 
  select(city_state) %>% 
  group_by(city_state) %>% 
  summarize(
    total_homocides = n()) 
 
number_unsolved = homicide_df %>% 
  select(city_state, resolution) %>% 
  filter(resolution == "unsolved") %>% 
  group_by(city_state) %>% 
  summarize(
    number_unsolved = n())

summary_within_city = left_join(number_unsolved, total_homocide) %>%  print()
```
* Summary: The table showing the number of unsolved homicides and total number of homicides in each city.


#### Look at the homicides in the city of Baltimore, MD
```{r}
baltimoreMD = homicide_df %>% 
  filter(city_state == "BaltimoreMD") %>% 
  summarize(
    unsolved = sum(resolution == "unsolved"),
    total_homocide = n())

baltimore_test = prop.test(
  x = baltimoreMD %>% pull(unsolved),
  n = baltimoreMD %>% pull(total_homocide))

baltimore_test %>% 
  broom::tidy() %>% 
  select(
    estimate,
    conf.low,
    conf.high)
```
* The table shows that the estimate proportion of unsolved homicides in Baltimore is 0.6456 and the confident interval is between 0.6276 and 0.6632.


#### Run the prop test for each cities
```{r}
## set up function
prop_test_function = function(city_df){
  
  city_summary =
    city_df %>% 
    summarize(
      unsolved = sum(resolution == "unsolved"),
      total = n()
      )
      
  city_test = prop.test(
    x = city_summary %>% pull(unsolved),
    n = city_summary %>% pull(total))
  
  return(city_test)
  }

## Perform prop test using map function
result_df = homicide_df %>% 
  nest(data = uid:resolution) %>% 
  mutate(
    test_result = map(data, prop_test_function),
    tidy_result = map(test_result, broom::tidy)
  ) %>% 
  select(
    city_state,
    tidy_result) %>% 
  unnest(tidy_result) %>% 
  select(
    city_state,
    estimate,
    starts_with("conf")) %>% 
  print()
  
## (Alternative) perform prop test using map2 function
homicide_df %>% 
  group_by(city_state) %>% 
  summarize(
    unsolved = sum(resolution == "unsolved"),
    total = n()) %>% 
  mutate(
    test_result = map2(unsolved, total, prop.test),
    tidy_result = map(test_result, broom::tidy)) %>% 
  unnest(tidy_result) %>% 
  select(city_state, estimate, starts_with("conf"))
  
```
* Summary: The table shows the estimate proportion of unsolved homicides and confident interval within each city.


#### Creata a plot show the estimate and CI for each city
```{r}
## Creating a plot
result_df %>% 
  mutate(
    city_state = fct_reorder(city_state, estimate)
  ) %>% 
  ggplot(aes(x= city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 90, vjust =0.5, hjust = 1)) +
  labs(
    x = "City_State",
    y = "Estimate",
    title = "Estimate and CIs for each city"
  )
```


## Problem 2

#### Create a tidy dataframe containing data from all participants, including the subject ID, arm, and observations over time
```{r, message=FALSE}
## Create a dataframe for all participants
all_participant_df = tibble(
  file_name = list.files(path = "./data/")) %>% 
  mutate(
    path = str_c("./data/", file_name),
    data = map(path, read_csv)) %>%         ## data is a variable that contain all results
  unnest(data) %>% 
  separate(file_name, into = c("arm", "subject_id"), sep = "_") %>% 
  mutate(
    subject_id = str_remove(subject_id, ".csv")
  ) %>% select(-path) %>% 
    pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "observation",
    names_prefix = "week_") %>% 
  mutate(
    week = as.numeric(week)
  ) %>%  print()
```
* Using the `list.files` to read the file_name and create a new variable containing the path for each file. Using `map` function to read all the results into a new variable containing a list of data. Then `unnest` the list and tidy the result. The data frame contains 160 observation and 4 variables. The variables include arms, subject_id, week, and observation. The data record the observation of each subject in controlled and experimental arms over 8 weeks.

####Create a dataframe for participants in controlled arm
```{r}
con_df = all_participant_df %>% 
  filter(arm == "con") %>% 
  print()
```
* The data frame only include the observation for each subject in controlled arm. There is 80 observation and 4 variables.

### Making spaghetti plot
```{r}
all_participant_df %>% 
  ggplot(aes(x = week, y = observation, color = arm, type = subject_id)) +
  geom_line() +
  labs(
    title = "Spaghetti Plot for observation of patients in controlled and experimental arm"
  )

```
* Comments: Comparing two arms, we notice that the observation for all patients in experimental arm are increasing over eight weeks. However, the observations for patients in controlled arm are relatively stable over the time. 


## Problem 3
```{r}
set.seed(10)

iris_with_missing = iris %>% 
  map_df(~replace(.x, sample(1:150, 20), NA)) %>%
  mutate(Species = as.character(Species))

fill_in_function = function(x) {
  if (is.numeric(x)) {
    x_mean = mean(x, na.rm = TRUE)
    x = replace_na(x, x_mean)
  }
  
  if (is.character(x)) {
    x = replace_na(x, "virginica")
  }
  
  return(x)
}

iris = map_df(iris_with_missing, fill_in_function) %>%  print()
```
* First, I write a function to fill in the missing value in the data frame. Then using `map` to iterate each column in the data frame. If variable is numeric, `NA` is replaced by the mean of non-missing value. If the variable is character, missing value is replaced by "Virginian". 
